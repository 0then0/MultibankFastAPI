<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multibank Aggregator - Open Banking</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
        background: #0a0e27;
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1629 100%);
        min-height: 100vh;
        color: #e2e8f0;
        padding: 0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Header */
      .header {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        padding: 20px 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        font-size: 28px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      .logo-text {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-actions {
        display: flex;
        gap: 15px;
      }

      /* Hero Section */
      .hero {
        text-align: center;
        padding: 80px 20px;
        max-width: 900px;
        margin: 0 auto;
      }

      .hero h1 {
        font-size: 56px;
        font-weight: 800;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.2;
      }

      .hero p {
        font-size: 20px;
        color: #94a3b8;
        margin-bottom: 40px;
        line-height: 1.6;
      }

      /* Stats */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 60px 0;
      }

      .stat-card {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        border-color: rgba(139, 92, 246, 0.5);
      }

      .stat-number {
        font-size: 48px;
        font-weight: 800;
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #94a3b8;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Auth Section */
      .auth-section {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 20px;
        padding: 40px;
        max-width: 500px;
        margin: 40px auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .auth-section h2 {
        font-size: 32px;
        margin-bottom: 30px;
        text-align: center;
      }

      /* Cards */
      .card {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        border-color: rgba(139, 92, 246, 0.3);
        box-shadow: 0 10px 40px rgba(139, 92, 246, 0.1);
      }

      .card h2 {
        font-size: 24px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Balance Card */
      .balance-card {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        color: white;
        text-align: center;
        padding: 60px 40px;
        border: none;
        position: relative;
        overflow: hidden;
      }

      .balance-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .balance-label {
        font-size: 16px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 15px;
      }

      .balance-amount {
        font-size: 64px;
        font-weight: 800;
        margin: 20px 0;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 1;
      }

      .balance-subtitle {
        font-size: 14px;
        opacity: 0.8;
      }

      /* Inputs and Buttons */
      input,
      button {
        width: 100%;
        padding: 16px 20px;
        margin: 10px 0;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        font-size: 16px;
        background: rgba(15, 23, 42, 0.5);
        color: #e2e8f0;
        transition: all 0.3s ease;
      }

      input:focus {
        outline: none;
        border-color: #8b5cf6;
        background: rgba(15, 23, 42, 0.8);
      }

      input::placeholder {
        color: #64748b;
      }

      button {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
      }

      button:hover::before {
        left: 100%;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      .btn-secondary {
        background: rgba(148, 163, 184, 0.1);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .btn-secondary:hover {
        background: rgba(148, 163, 184, 0.2);
        box-shadow: 0 10px 30px rgba(148, 163, 184, 0.2);
      }

      .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .logout-btn:hover {
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
      }

      /* Lists */
      .account-list,
      .transaction-list {
        list-style: none;
      }

      .account-item,
      .transaction-item {
        padding: 20px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .account-item:hover,
      .transaction-item:hover {
        background: rgba(139, 92, 246, 0.05);
        padding-left: 25px;
      }

      .account-item:last-child,
      .transaction-item:last-child {
        border-bottom: none;
      }

      .item-info strong {
        color: #e2e8f0;
        font-size: 16px;
        display: block;
        margin-bottom: 5px;
      }

      .item-info small {
        color: #64748b;
        font-size: 13px;
      }

      .amount-positive {
        color: #22c55e;
        font-weight: 700;
        font-size: 18px;
      }

      .amount-negative {
        color: #ef4444;
        font-weight: 700;
        font-size: 18px;
      }

      /* Premium Badge */
      .premium-badge {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #000;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
      }

      /* Error */
      .error {
        color: #fca5a5;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 12px;
        padding: 15px;
        margin: 15px 0;
      }

      /* Dashboard */
      .dashboard {
        display: none;
        padding: 40px 0;
      }

      .dashboard.active {
        display: block;
      }

      /* Analytics Grid */
      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .analytics-item {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 16px;
        padding: 25px;
        text-align: center;
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      .analytics-label {
        font-size: 14px;
        color: #94a3b8;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .analytics-value {
        font-size: 32px;
        font-weight: 800;
      }

      /* User Header */
      .user-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
      }

      /* Grid Layout */
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
      }

      @media (max-width: 768px) {
        .hero h1 {
          font-size: 36px;
        }

        .hero p {
          font-size: 16px;
        }

        .balance-amount {
          font-size: 48px;
        }

        .grid-2 {
          grid-template-columns: 1fr;
        }

        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Loading Animation */
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      .loading {
        background: linear-gradient(
          90deg,
          rgba(148, 163, 184, 0.1) 0%,
          rgba(148, 163, 184, 0.2) 50%,
          rgba(148, 163, 184, 0.1) 100%
        );
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <span class="logo-icon">üè¶</span>
            <span class="logo-text">Multibank Aggregator</span>
          </div>
          <div class="header-actions" id="header-actions">
            <button
              class="btn-secondary"
              onclick="scrollToAuth()"
              style="width: auto; padding: 12px 24px"
            >
              –í–æ–π—Ç–∏
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hero Section -->
    <div class="container">
      <div class="hero" id="hero-section">
        <h1>–ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞</h1>
        <p>
          –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Å–µ–º–∏ —Å–≤–æ–∏–º–∏ —Å—á–µ—Ç–∞–º–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ. Open Banking API –¥–ª—è
          —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏.
        </p>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-number">3</div>
            <div class="stat-label">–ë–∞–Ω–∫–∞-–ø–∞—Ä—Ç–Ω–µ—Ä–∞</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="users-count">0</div>
            <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="accounts-count">0</div>
            <div class="stat-label">–°—á–µ—Ç–æ–≤</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="transactions-count">0</div>
            <div class="stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
          </div>
        </div>
      </div>

      <!-- Auth Section -->
      <div id="auth-section" class="auth-section">
        <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <div id="auth-error" class="error" style="display: none"></div>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" />
        <input type="text" id="full-name" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)" />
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <button class="btn-secondary" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>

      <!-- Dashboard -->
      <div id="dashboard" class="dashboard">
        <!-- User Header -->
        <div class="card">
          <div class="user-header">
            <div class="user-info">
              <div class="user-avatar" id="user-avatar">–£</div>
              <div>
                <h2 style="margin: 0">
                  –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!
                  <span id="premium-badge" style="display: none" class="premium-badge"
                    >Premium</span
                  >
                </h2>
              </div>
            </div>
            <button class="logout-btn" onclick="logout()" style="width: auto; padding: 12px 30px">
              –í—ã–π—Ç–∏
            </button>
          </div>
        </div>

        <!-- Balance Card -->
        <div class="card balance-card">
          <div class="balance-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
          <div class="balance-amount" id="total-balance">0 ‚ÇΩ</div>
          <div class="balance-subtitle">–í—Å–µ —Å—á–µ—Ç–∞</div>
        </div>

        <!-- Accounts and Transactions Grid -->
        <div class="grid-2">
          <div class="card">
            <h2>üí≥ –í–∞—à–∏ —Å—á–µ—Ç–∞</h2>
            <ul id="accounts-list" class="account-list"></ul>
          </div>

          <div class="card">
            <h2>üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
            <ul id="transactions-list" class="transaction-list"></ul>
          </div>
        </div>

        <!-- Analytics -->
        <div class="card">
          <h2>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h2>
          <div id="analytics-content" class="analytics-grid"></div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = 'http://localhost:8000/api/v1';
      let token = localStorage.getItem('token');
      let currentUser = null;

      // Show loading state
      function showLoading(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #64748b;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        }
      }

      // Show error state
      function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">${message}</div>`;
        }
      }

      function scrollToAuth() {
        document.getElementById('auth-section').scrollIntoView({
          behavior: 'smooth',
        });
      }

      async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
          showAuthError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
          return;
        }

        try {
          const formData = new FormData();
          formData.append('username', email);
          formData.append('password', password);

          const response = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
          }

          const data = await response.json();
          token = data.access_token;
          localStorage.setItem('token', token);

          // Clear form
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';

          await showDashboard();
        } catch (error) {
          showAuthError(error.message);
        }
      }

      async function register() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const fullName = document.getElementById('full-name').value;

        if (!email || !password || !fullName) {
          showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              password,
              full_name: fullName,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
          }

          alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
          document.getElementById('full-name').value = '';
        } catch (error) {
          showAuthError(error.message);
        }
      }

      function logout() {
        localStorage.removeItem('token');
        token = null;
        currentUser = null;
        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('hero-section').style.display = 'block';
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('header-actions').innerHTML = `
            <button class="btn-secondary" onclick="scrollToAuth()" style="width: auto; padding: 12px 24px;">
                –í–æ–π—Ç–∏
            </button>
        `;
      }

      async function loadCurrentUser() {
        try {
          const response = await fetch(`${API_URL}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            if (response.status === 401) {
              logout();
              return;
            }
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
          }

          currentUser = await response.json();

          const userName = currentUser.full_name || currentUser.email;
          document.getElementById('user-name').textContent = userName;

          // Set avatar initial
          const initial = userName.charAt(0).toUpperCase();
          document.getElementById('user-avatar').textContent = initial;

          if (currentUser.is_premium) {
            document.getElementById('premium-badge').style.display = 'inline-block';
          }

          // Update header
          document.getElementById('header-actions').innerHTML = `
                <button class="logout-btn" onclick="logout()" style="width: auto; padding: 12px 24px;">
                    –í—ã–π—Ç–∏
                </button>
            `;
        } catch (error) {
          console.error('Error loading user:', error);
          showAuthError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
        }
      }

      async function showDashboard() {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('hero-section').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');

        // Show loading states
        showLoading('accounts-list');
        showLoading('transactions-list');
        showLoading('analytics-content');

        // Load all data
        await loadCurrentUser();
        await loadAccounts();
        await loadTransactions();
        await loadAnalytics();
      }

      async function loadAccounts() {
        try {
          const response = await fetch(`${API_URL}/accounts/aggregated`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞');
          }

          const data = await response.json();

          // Update total balance
          const balance = data.total_balance || 0;
          document.getElementById('total-balance').textContent = `${balance.toLocaleString(
            'ru-RU',
            {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            },
          )} ‚ÇΩ`;

          // Update accounts list
          const accountsList = document.getElementById('accounts-list');
          if (data.accounts && data.accounts.length > 0) {
            accountsList.innerHTML = data.accounts
              .map(
                (acc) => `
                    <li class="account-item">
                        <div class="item-info">
                            <strong>${acc.account_name || acc.account_type || '–°—á–µ—Ç'}</strong>
                            <small>${acc.external_account_id || acc.bank_name}</small>
                        </div>
                        <div class="amount-positive">
                            ${(acc.balance || 0).toLocaleString('ru-RU', {
                              minimumFractionDigits: 2,
                              maximumFractionDigits: 2,
                            })} ‚ÇΩ
                        </div>
                    </li>
                `,
              )
              .join('');
          } else {
            accountsList.innerHTML = `
                    <li class="account-item" style="justify-content: center; color: #64748b;">
                        <div style="text-align: center;">
                            <div style="margin-bottom: 10px;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤</div>
                            <button onclick="connectBank()" style="width: auto; padding: 10px 20px;">
                                –ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–∞–Ω–∫
                            </button>
                        </div>
                    </li>
                `;
          }
        } catch (error) {
          console.error('Error loading accounts:', error);
          showError('accounts-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç–æ–≤');
        }
      }

      async function loadTransactions() {
        try {
          const response = await fetch(`${API_URL}/transactions?limit=10`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
          }

          const transactions = await response.json();
          const transactionsList = document.getElementById('transactions-list');

          if (transactions && transactions.length > 0) {
            transactionsList.innerHTML = transactions
              .map((tx) => {
                const amount = tx.amount || 0;
                const isPositive = amount >= 0;

                return `
                        <li class="transaction-item">
                            <div class="item-info">
                                <strong>${
                                  tx.description || tx.merchant_name || '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è'
                                }</strong>
                                <small>${new Date(tx.transaction_date).toLocaleDateString('ru-RU', {
                                  year: 'numeric',
                                  month: 'long',
                                  day: 'numeric',
                                })}</small>
                            </div>
                            <div class="${isPositive ? 'amount-positive' : 'amount-negative'}">
                                ${isPositive ? '+' : ''}${amount.toLocaleString('ru-RU', {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                })} ‚ÇΩ
                            </div>
                        </li>
                    `;
              })
              .join('');
          } else {
            transactionsList.innerHTML = `
                    <li class="transaction-item" style="justify-content: center; color: #64748b;">
                        –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                    </li>
                `;
          }
        } catch (error) {
          console.error('Error loading transactions:', error);
          showError('transactions-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
        }
      }

      async function loadAnalytics() {
        try {
          const response = await fetch(`${API_URL}/analytics/monthly-summary`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É');
          }

          const data = await response.json();
          const analyticsContent = document.getElementById('analytics-content');

          analyticsContent.innerHTML = `
                <div class="analytics-item">
                    <div class="analytics-label">–î–æ—Ö–æ–¥—ã</div>
                    <div class="analytics-value amount-positive">
                        +${(data.income || 0).toLocaleString('ru-RU', {
                          minimumFractionDigits: 0,
                          maximumFractionDigits: 0,
                        })} ‚ÇΩ
                    </div>
                </div>
                <div class="analytics-item">
                    <div class="analytics-label">–†–∞—Å—Ö–æ–¥—ã</div>
                    <div class="analytics-value amount-negative">
                        -${(data.expenses || 0).toLocaleString('ru-RU', {
                          minimumFractionDigits: 0,
                          maximumFractionDigits: 0,
                        })} ‚ÇΩ
                    </div>
                </div>
                <div class="analytics-item">
                    <div class="analytics-label">–ë–∞–ª–∞–Ω—Å</div>
                    <div class="analytics-value" style="color: #e2e8f0;">
                        ${(data.net || 0).toLocaleString('ru-RU', {
                          minimumFractionDigits: 0,
                          maximumFractionDigits: 0,
                        })} ‚ÇΩ
                    </div>
                </div>
            `;
        } catch (error) {
          console.error('Error loading analytics:', error);
          showError('analytics-content', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');
        }
      }

      async function connectBank() {
        if (!confirm('–ü–æ–¥–∫–ª—é—á–∏—Ç—å VTB Bank?')) return;

        try {
          const response = await fetch(`${API_URL}/banks/connect`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–∞–Ω–∫');
          }

          const data = await response.json();
          alert(`–ë–∞–Ω–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω! ID: ${data.bank_connection_id}`);

          // Sync data
          await syncBank(data.bank_connection_id);
        } catch (error) {
          alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
      }

      async function syncBank(connectionId) {
        try {
          const response = await fetch(`${API_URL}/banks/sync/${connectionId}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
          }

          const data = await response.json();
          alert(
            `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${data.synced.accounts} —Å—á–µ—Ç–æ–≤, ${data.synced.transactions} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`,
          );

          // Reload data
          await loadAccounts();
          await loadTransactions();
          await loadAnalytics();
        } catch (error) {
          alert(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`);
        }
      }

      function showAuthError(message) {
        const errorDiv = document.getElementById('auth-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => (errorDiv.style.display = 'none'), 5000);
      }

      // Animate stats on load
      function animateValue(id, start, end, duration) {
        const element = document.getElementById(id);
        if (!element) return;

        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;

        const timer = setInterval(() => {
          current += increment;
          if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
          }
          element.textContent = Math.floor(current);
        }, 16);
      }

      // Check if user is already logged in on page load
      if (token) {
        console.log('Token found, loading dashboard...');
        showDashboard();
      } else {
        console.log('No token, showing landing page');
        // Animate stats for landing page
        animateValue('users-count', 0, 150, 2000);
        animateValue('accounts-count', 0, 450, 2000);
        animateValue('transactions-count', 0, 15000, 2000);
      }
    </script>
  </body>
</html>
